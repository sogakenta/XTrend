# XTrend タスクリスト

最終更新: 2026-02-17 (v2)

---

## 凡例

| ステータス | 意味 |
|-----------|------|
| ✅ | 完了 |
| 🚧 | 進行中 |
| 📋 | 予定（未着手） |
| 🔍 | 検討中（要判断） |
| ⏸️ | 保留 |

---

## Phase 0: 緊急対応（正しさの問題）

| # | タスク | ステータス | 備考 |
|---|--------|-----------|------|
| P0-1 | rankChangeの時点固定 | ✅ | `resolveCapturedAt()`で実装 |
| P0-2 | durationHoursの連続判定修正 | ✅ | gap検出ロジック実装 |
| P0-3 | regionCountの時点固定 | ✅ | 範囲クエリ→同一captured_at |

---

## Phase 1: 即時最適化

| # | タスク | ステータス | 備考 |
|---|--------|-----------|------|
| P1-1 | revalidate=600に変更 | ✅ | page.tsx, place/[slug]/page.tsx |
| P1-2 | offsetのプリセット制限 | ✅ | 不正値はリダイレクト |
| P1-3 | TimeOffsetTabsに48h/72h追加 | ✅ | lib/constants.tsに分離 |

---

## Phase 2: UI機能拡張

| # | タスク | ステータス | 難易度 | 備考 |
|---|--------|-----------|--------|------|
| P2-1 | DB負荷可視化（開発者向け） | 📋 | M | ドキュメント整備、負荷予算明記 |
| P2-2 | DB負荷可視化（運用向け） | 📋 | M | ingest_runベースのダッシュボード |
| P2-3 | トップページ表示件数緩和 | 📋 | S | 20件→50件、折りたたみ対応 |
| P2-4 | /termページの並び替え機能 | 📋 | S | 昇順/降順切替ボタン（クライアント側） |
| P2-5 | 欠損時刻のUI表示 | 📋 | S | 「データなし」を明示 |

---

## Phase 3: 表示カスタマイズ機能

| # | タスク | ステータス | 難易度 | 備考 |
|---|--------|-----------|--------|------|
| P3-1 | 列選択メニュー設計 | 🔍 | M | URL(?cols=0,1,3)+localStorage |
| P3-2 | 追加列データ取得API | 📋 | M | Route Handler + キャッシュ |
| P3-3 | 多時間軸表示（競合型） | 📋 | H | 24時間分のスナップショット表示 |
| P3-4 | モバイル対応（タブ表示） | 📋 | M | 列数上限、レスポンシブ |

---

## Phase 4: シグナル事前計算

| # | タスク | ステータス | 難易度 | 備考 |
|---|--------|-----------|--------|------|
| P4-1 | trend_signal_hourlyテーブル設計 | 📋 | M | スキーマはdocs/002に記載済み |
| P4-2 | compute_signals SQL/RPC実装 | 📋 | M | |
| P4-3 | ingest連携（バッチ完了後に計算） | 📋 | M | |
| P4-4 | Web側をJOINクエリに変更 | 📋 | S | |
| P4-5 | バックフィル（既存データへのシグナル計算） | 📋 | S | |

---

## Phase 5: On-Demand Revalidation

| # | タスク | ステータス | 難易度 | 備考 |
|---|--------|-----------|--------|------|
| P5-1 | /api/revalidate エンドポイント実装 | 📋 | M | 設計はdocs/003に記載済み |
| P5-2 | Batch側のtriggerRevalidate実装 | 📋 | S | |
| P5-3 | 署名検証（HMAC-SHA256） | 📋 | S | |
| P5-4 | 環境変数設定（REVALIDATE_SECRET） | 📋 | S | |

---

## 検討中の項目

| # | 項目 | ステータス | 検討内容 |
|---|------|-----------|---------|
| D-1 | Web本番環境 | 🔍 | Vercel or Cloud Run？ |
| D-2 | Cloud Runインスタンス数 | 🔍 | 複数の場合は共有cache handler必要 |
| D-3 | /termページの再検証 | 🔍 | 初期は対象外を推奨 |
| D-4 | 更新頻度（30分更新） | 🔍 | X API Basicプラン範囲内で可能 |
| D-5 | 列選択の最大数 | 🔍 | 4列上限を推奨（キャッシュキー爆発防止） |
| D-6 | 1列の表示件数 | 🔍 | 20件→50件、折りたたみ？ |
| D-7 | モバイル表示方式 | 🔍 | 多カラム→タブ切替？ |

---

## DB負荷の見積もり

### 現状（Phase 1完了後）

| 項目 | 値 | 備考 |
|------|-----|------|
| ISR revalidate | 600秒（10分） | 1時間に6回再生成 |
| 1リクエストの読み取り | 約100行 | 時点固定クエリ |
| DB読み取り/日（3地域） | 約1.5万行 | ISR活用 |
| ingest書き込み/日 | 3,600行 | 50件×3地域×24時間 |

### 将来（53地域スケール時）

| 項目 | 現状設計 | 最適化後（Phase 4完了） |
|------|---------|------------------------|
| 1リクエストの読み取り | 約100行 | 約100行（変化なし） |
| シグナル計算 | リクエスト時 | ingest時（1時間に1回） |

### 危険な兆候

| 兆候 | 対応 |
|------|------|
| Supabase max_rows（1000行）到達 | Phase 4のシグナル事前計算を実施 |
| Egress 5GB/月超過 | ISR revalidateを延長 |
| ページ生成P95が3秒超過 | シグナル事前計算 or JSON配信 |

---

## 見送り事項

| 項目 | 理由 |
|------|------|
| DB移行（Neon等） | 今の課題はDB製品ではない |
| マテリアライズドビュー | 53地域でrefreshコスト問題 |
| 完全SSG | 動的ページ運用を切る判断が必要 |
| 全シグナル一括実装 | まず最小差別化で検証 |

---

## 直近の完了履歴

| 日付 | コミット | 内容 |
|------|---------|------|
| 2026-02-17 | 43b0bdc | シグナル計算の時点固定とISR設定最適化 |
| 2026-02-16 | e38acf7 | アーキテクチャ根本レビュー追加 |
| 2026-02-16 | cca01cf | On-Demand Revalidation 設計ドキュメント追加 |
| 2026-02-16 | 6336bbe | DB負荷対策の設計ドキュメント追加 |
| 2026-02-16 | b6c1443 | トレンドシグナル機能の設計ドキュメント追加 |

---

## 関連ドキュメント

- [統合仕様書](./2026-02-17-001-integrated-spec.md)
- [トレンドシグナル機能設計](./2026-02-16-001-trend-signals-design.md)
- [DB負荷対策設計](./2026-02-16-002-db-optimization-design.md)
- [On-Demand Revalidation設計](./2026-02-16-003-on-demand-revalidation.md)
- [アーキテクチャ根本レビュー](./2026-02-16-004-architecture-review.md)
